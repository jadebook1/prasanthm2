#!/bin/bash

# Function to execute a SQL query and store the result in a variable
execute_query() {
  local query="$1"
  local result=$(db2 -x "$query")
  echo "$result"
}

# Main script logic
main() {
  # Variables to store accumulated data
  main_table=""
  join_tables=""
  join_conditions=""

  # Read the CSV file and process the data
  while IFS=, read -r table_name column_name key_column referenced_table referenced_column
  do
    if [ -z "$main_table" ]; then
      main_table="$table_name"
    else
      join_tables+=" $table_name"
      join_conditions+=" $table_name.$key_column = $referenced_table.$referenced_column AND"
    fi

    echo "Processed table: $table_name"
  done < your_csv_file.csv

  # Remove trailing "AND" from join conditions
  join_conditions=${join_conditions%" AND"}

  # Generate the dynamic SQL query
  query="SELECT * FROM $main_table $join_tables ON $join_conditions;"

  # Execute the query
  execute_query "$query"

  echo "Query executed"
}

# Execute the main script
main
